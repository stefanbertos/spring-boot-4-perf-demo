plugins {
    id 'org.springframework.boot' version '4.0.1' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
    id 'com.github.davidmc24.gradle.plugin.avro' version '1.9.1' apply false
    id 'org.sonarqube' version '7.2.2.6593'
    id 'jacoco'
    id 'jacoco-report-aggregation'
    id 'org.asciidoctor.jvm.convert' version '4.0.4'
    id 'org.asciidoctor.jvm.pdf' version '4.0.4'
}

repositories {
    mavenCentral()
}

// ==================== Build Profile Configuration ====================
// Usage:
//   ./gradlew build                              # Default: docker-compose profile
//   ./gradlew build -Pprofile=docker             # Explicit docker-compose profile
//   ./gradlew build -Pprofile=kubernetes         # Kubernetes/Helm/Rancher profile
//
// Profile determines:
//   - docker:     includes spring-boot-docker-compose, uses localhost URLs
//   - kubernetes: excludes docker-compose, uses Kubernetes service URLs
ext {
    buildProfile = project.hasProperty('profile') ? project.property('profile') : 'docker'
    isDockerProfile = buildProfile == 'docker'
    isKubernetesProfile = buildProfile == 'kubernetes'
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    apply plugin: 'checkstyle'
    apply plugin: 'pmd'
    apply plugin: 'jacoco'

    group = 'com.example'
    version = '0.0.1-SNAPSHOT'

    // Propagate profile to subprojects
    ext {
        buildProfile = rootProject.ext.buildProfile
        isDockerProfile = rootProject.ext.isDockerProfile
        isKubernetesProfile = rootProject.ext.isKubernetesProfile
    }

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(25)
        }
    }

    // ==================== Checkstyle Configuration ====================
    checkstyle {
        toolVersion = '10.21.4'
        configFile = rootProject.file('config/checkstyle/checkstyle.xml')
        configProperties = ['suppressionFile': rootProject.file('config/checkstyle/suppressions.xml')]
        ignoreFailures = false
        maxWarnings = 0
        maxErrors = 0
    }

    tasks.withType(Checkstyle).configureEach {
        exclude '**/com/example/avro/**'
        reports {
            xml.required = true
            html.required = true
        }
    }

    // ==================== PMD Configuration ====================
    pmd {
        toolVersion = '7.20.0'
        consoleOutput = true
        ruleSetFiles = rootProject.files('config/pmd/ruleset.xml')
        ignoreFailures = false
        rulesMinimumPriority = 5
    }

    tasks.withType(Pmd).configureEach {
        exclude '**/com/example/avro/**'
        reports {
            xml.required = true
            html.required = true
        }
    }

    // ==================== JaCoCo Configuration ====================
    jacoco {
        toolVersion = '0.8.14'
    }

    tasks.named('test') {
        useJUnitPlatform()
        finalizedBy jacocoTestReport
    }

    jacocoTestReport {
        dependsOn test
        reports {
            xml.required = true
            html.required = true
        }
    }

    jacocoTestCoverageVerification {
        dependsOn jacocoTestReport
        violationRules {
            rule {
                element = 'CLASS'
                excludes = [
                    '*.Application',
                    '*.*Application',
                    '*.*Config',
                    '*.config.*',
                    '*.grafana.*',
                    '*.prometheus.*',
                    '*.kubernetes.*',
                    '*.export.*',
                    '*.apigateway.*',
                    '*.persistence.*',
                    '*.avro.*',
                    '*.serialization.*',
                    '*.admin.*',
                    '*AdminController',
                    '*AdminController$*',
                    '*AdminController.*'
                ]
                limit {
                    minimum = 0.8  // 80% coverage required per class
                }
            }
        }
    }

    // ==================== Build Order ====================
    tasks.named('jar') {
        dependsOn tasks.named('checkstyleMain')
        dependsOn tasks.named('pmdMain')
    }

    tasks.named('bootJar') {
        dependsOn tasks.named('checkstyleMain')
        dependsOn tasks.named('pmdMain')
    }

    tasks.named('check') {
        dependsOn jacocoTestCoverageVerification
    }

    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }

    repositories {
        mavenCentral()
    }

    dependencies {
        implementation 'org.springframework.boot:spring-boot-starter-actuator'
        implementation 'org.springframework:spring-aop'
        implementation 'org.aspectj:aspectjweaver'

        compileOnly 'org.projectlombok:lombok'
        runtimeOnly 'io.micrometer:micrometer-registry-prometheus'
        annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
        annotationProcessor 'org.projectlombok:lombok'

        // Docker Compose support - only for docker profile
        if (isDockerProfile) {
            developmentOnly 'org.springframework.boot:spring-boot-docker-compose'
        }

        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

        // Mockito for mocking
        testImplementation 'org.mockito:mockito-core'
        testImplementation 'org.mockito:mockito-junit-jupiter'
    }

    tasks.named('bootRun') {
        jvmArgs = ['-XX:+UseZGC', '-XX:+UseContainerSupport']
        // Set Spring profile based on build profile
        if (isKubernetesProfile) {
            systemProperty 'spring.profiles.active', 'kubernetes'
        }
    }

    // Log active build profile
    tasks.register('showProfile') {
        group = 'help'
        description = 'Shows the active build profile'
        doLast {
            println "Active build profile: ${buildProfile}"
            println "Docker Compose support: ${isDockerProfile ? 'ENABLED' : 'DISABLED'}"
            println "Kubernetes/Helm mode: ${isKubernetesProfile ? 'ENABLED' : 'DISABLED'}"
        }
    }
}

// ==================== Aggregated JaCoCo Report ====================
dependencies {
    subprojects.each { subproject ->
        jacocoAggregation project(subproject.path)
    }
}

tasks.register('jacocoAggregatedReport', JacocoReport) {
    dependsOn subprojects.collect { it.tasks.named('test') }

    additionalSourceDirs.from(subprojects.collect { it.sourceSets.main.allSource.srcDirs }.flatten())
    sourceDirectories.from(subprojects.collect { it.sourceSets.main.allSource.srcDirs }.flatten())
    classDirectories.from(subprojects.collect { it.sourceSets.main.output }.flatten())
    executionData.from(subprojects.collect {
        it.tasks.named('test').map { task -> task.extensions.getByType(JacocoTaskExtension).destinationFile }
    })

    reports {
        xml.required = true
        html.required = true
        html.outputLocation = layout.buildDirectory.dir('reports/jacoco/aggregated/html')
        xml.outputLocation = layout.buildDirectory.file('reports/jacoco/aggregated/jacoco.xml')
    }
}

// ==================== SonarQube Configuration ====================
// URLs differ based on profile:
//   docker:     http://localhost:9001 (port-forwarded or docker-compose)
//   kubernetes: http://perf-sonarqube:9000/sonar (Kubernetes service)
ext {
    sonarUrlDocker = 'http://localhost:9001'
    sonarUrlKubernetes = 'http://localhost/sonar'
    sonarDefaultUrl = sonarUrlKubernetes
}

sonar {
    properties {
        property 'sonar.projectKey', 'spring-boot-4-perf-demo'
        property 'sonar.projectName', 'Spring Boot 4 Performance Demo'
        property 'sonar.host.url', System.getenv('SONAR_HOST_URL') ?: sonarDefaultUrl
        property 'sonar.token', System.getenv('SONAR_TOKEN') ?: ''
        property 'sonar.sourceEncoding', 'UTF-8'
        property 'sonar.java.source', '25'
        property 'sonar.coverage.jacoco.xmlReportPaths', subprojects.collect {
            "${it.layout.buildDirectory.get()}/reports/jacoco/test/jacocoTestReport.xml"
        }.join(',')
        property 'sonar.junit.reportPaths', subprojects.collect {
            "${it.layout.buildDirectory.get()}/test-results/test"
        }.join(',')
    }
}

tasks.named('sonar') {
    dependsOn subprojects.collect { it.tasks.named('test') }
    dependsOn subprojects.collect { it.tasks.named('jacocoTestReport') }
}

// ==================== Documentation Generation ====================
asciidoctorj {
    jrubyVersion = '9.4.9.0'
    modules {
        diagram.use()
        diagram.version '2.3.1'
    }
}

// JRuby (used by AsciidoctorJ) requires open access to JDK IO subsystem on Java 17+
def asciidoctorJvmArgs = [
    '--add-opens', 'java.base/sun.nio.ch=ALL-UNNAMED',
    '--add-opens', 'java.base/java.io=ALL-UNNAMED'
]

tasks.named('asciidoctor') {
    jvm {
        jvmArgs.addAll(asciidoctorJvmArgs)
    }
    sourceDir = file('docs/asciidoc')
    sources {
        include 'index.adoc'
    }
    baseDirFollowsSourceDir()
    outputDir = layout.buildDirectory.dir('docs/html')
    attributes = [
        'source-highlighter': 'rouge',
        'toc': 'left',
        'toclevels': '3',
        'sectnums': '',
        'icons': 'font',
        'idprefix': '',
        'idseparator': '-',
        'revnumber': project.version,
        'revdate': new Date().format('yyyy-MM-dd'),
        'project-name': 'Spring Boot 4 Performance Demo',
        'imagesdir': 'images',
        'docdir': file('docs/asciidoc').absolutePath
    ]
}

tasks.named('asciidoctorPdf') {
    jvm {
        jvmArgs.addAll(asciidoctorJvmArgs)
    }
    sourceDir = file('docs/asciidoc')
    sources {
        include 'index.adoc'
    }
    baseDirFollowsSourceDir()
    outputDir = layout.buildDirectory.dir('docs/pdf')
    attributes = [
        'source-highlighter': 'rouge',
        'toc': 'book',
        'toclevels': '3',
        'sectnums': '',
        'icons': 'font',
        'idprefix': '',
        'idseparator': '-',
        'revnumber': project.version,
        'revdate': new Date().format('yyyy-MM-dd'),
        'project-name': 'Spring Boot 4 Performance Demo',
        'imagesdir': 'images',
        'docdir': file('docs/asciidoc').absolutePath,
        'pdf-theme': 'custom',
        'pdf-themesdir': file('docs/asciidoc/themes').absolutePath,
        'pdf-fontsdir': file('docs/asciidoc/fonts').absolutePath
    ]
}

tasks.register('generateDocs') {
    group = 'documentation'
    description = 'Generates HTML and PDF documentation'
    dependsOn 'asciidoctor', 'asciidoctorPdf'
}

// Include documentation generation in the build
tasks.named('build') {
    dependsOn 'generateDocs'
}
