= Component Testing

== Overview

Each module includes BDD-style component tests using **Cucumber 7.x** and **Testcontainers**. These tests validate end-to-end behavior with real infrastructure (Kafka, IBM MQ) running in Docker containers.

Component tests are _not_ wired into the standard `build` or `check` tasks because they require Docker to be running.

== Running Component Tests

[source,bash]
----
# Run all component tests (requires Docker)
./gradlew componentTest

# Run component tests for a specific module
./gradlew :kafka-consumer:componentTest
./gradlew :ibm-mq-consumer:componentTest
./gradlew :perf-tester:componentTest
./gradlew :config-server:componentTest
./gradlew :api-gateway:componentTest
----

== Test Reports

After execution, Cucumber HTML reports are generated at:

----
<module>/build/reports/cucumber/cucumber-report.html
----

== Module Coverage

The following table summarizes what each module's component tests validate:

[cols="1,2,2", options="header"]
|===
| Module | Infrastructure | Validates

| kafka-consumer
| Testcontainers Kafka
| Message processing (content + " processed" suffix), Kafka header forwarding

| ibm-mq-consumer
| Testcontainers Kafka + IBM MQ
| MQ-to-Kafka bridging, Kafka-to-MQ response routing

| perf-tester
| Testcontainers IBM MQ
| MQ send/receive, latency tracking

| config-server
| None (in-process)
| Config serving via REST API

| api-gateway
| WireMock stubs
| Gateway routing to backend services
|===

== Project Structure

Each module follows the same layout for component tests:

----
<module>/
└── src/componentTest/
    ├── java/com/example/<module>/componenttest/
    │   ├── CucumberTest.java          # JUnit Platform suite entry point
    │   ├── TestContainersConfig.java   # Testcontainers setup (if needed)
    │   └── steps/
    │       └── *Steps.java            # Cucumber step definitions
    └── resources/
        ├── application-componenttest.yml  # Test-specific Spring config
        └── features/
            └── *.feature              # Cucumber feature files (Gherkin)
----

== Feature File Example

Feature files describe test scenarios in Gherkin syntax:

[source,gherkin]
----
Feature: Kafka message processing
  The kafka-consumer receives Avro messages on the request topic,
  appends " processed" to the content, and publishes to the response topic.

  Scenario: Process a single message
    Given the Kafka topics "mq-requests" and "mq-responses" exist
    When a message with content "hello world" is sent to topic "mq-requests"
    Then within 10 seconds a message appears on topic "mq-responses"
         with content "hello world processed"

  Scenario: Headers are preserved through processing
    Given the Kafka topics "mq-requests" and "mq-responses" exist
    When a message with content "test" and header "mq-reply-to" = "queue:///DEV.QUEUE.1"
         is sent to topic "mq-requests"
    Then within 10 seconds a message appears on topic "mq-responses"
         with header "mq-reply-to" = "queue:///DEV.QUEUE.1"
----

== Key Dependencies

Component tests use the following libraries (configured in the root `build.gradle`):

[cols="1,2", options="header"]
|===
| Library | Purpose

| Cucumber 7.x
| BDD test framework with Gherkin syntax

| Testcontainers
| Docker-based infrastructure for tests

| Awaitility
| Asynchronous assertion helper (polling with timeouts)

| Spring Boot Test
| Application context and test utilities
|===

== Writing New Component Tests

1. Create a `.feature` file in `src/componentTest/resources/features/`
2. Implement step definitions in `src/componentTest/java/.../steps/`
3. If new infrastructure is needed, configure Testcontainers in `TestContainersConfig.java`
4. Run with `./gradlew :<module>:componentTest`
