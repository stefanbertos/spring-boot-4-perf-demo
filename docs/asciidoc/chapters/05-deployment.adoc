= Deployment Guide

== Deployment Options

The application supports multiple deployment strategies:

[cols="2,3,2"]
|===
|Option |Use Case |Complexity

|Docker Compose
|Local development, testing
|Low

|Kubernetes (Helm)
|Production, cloud deployment
|Medium

|GCP/GKE
|Google Cloud production
|Medium
|===

== Docker Compose Deployment

=== Starting All Services

[source,bash]
----
# Build and start all services
docker compose -f infrastructure/docker/compose.yaml up --build

# Start in detached mode
docker compose -f infrastructure/docker/compose.yaml up -d --build

# View logs
docker compose -f infrastructure/docker/compose.yaml logs -f

# Stop all services
docker compose -f infrastructure/docker/compose.yaml down

# Stop and remove volumes
docker compose -f infrastructure/docker/compose.yaml down -v
----

=== Scaling Services

Scale specific services for load testing:

[source,bash]
----
# Scale ibm-mq-consumer to 10 replicas
docker compose -f infrastructure/docker/compose.yaml up -d --scale ibm-mq-consumer=10

# Scale kafka-consumer to 10 replicas
docker compose -f infrastructure/docker/compose.yaml up -d --scale kafka-consumer=10
----

=== Resource Allocation

Recommended resources for Docker Desktop:

[cols="2,1,1"]
|===
|Setting |Minimum |Recommended

|Memory
|8 GB
|16 GB

|CPUs
|4
|8

|Disk
|50 GB
|100 GB
|===

== Kubernetes Deployment with ArgoCD

The application uses **ArgoCD** (App of Apps pattern) for GitOps Kubernetes deployment. ArgoCD watches `infrastructure/argocd/apps/` and deploys all services in the correct dependency order using sync waves.

=== Prerequisites

* Kubernetes cluster (Rancher Desktop, minikube, kind, GKE, EKS, AKS)
* `kubectl` configured and pointing to the target cluster
* Container images built and available in the cluster's image registry

=== Build Images First

For local clusters (Rancher Desktop), build images directly into the local Docker daemon:

[source,bash]
----
./gradlew dockerBuildAll
----

=== Bootstrap ArgoCD and Deploy

[source,bash]
----
# Full setup: installs ArgoCD into 'argocd' namespace, then deploys all apps
infrastructure\deployArgo.bat
----

The script:

. Installs ArgoCD into the `argocd` namespace
. Applies `infrastructure/argocd/project.yaml` (AppProject)
. Applies `infrastructure/argocd/root-app.yaml` (root Application)
. ArgoCD then deploys all child Applications in sync wave order

=== Manual ArgoCD Bootstrap

[source,bash]
----
# Install ArgoCD
kubectl create namespace argocd
kubectl apply -n argocd \
  -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Apply project and root app
kubectl apply -f infrastructure/argocd/project.yaml
kubectl apply -f infrastructure/argocd/root-app.yaml
----

=== Verifying Deployment

[source,bash]
----
# Check ArgoCD applications
kubectl get applications -n argocd

# Check all pods in perf-demo
kubectl get pods -n perf-demo

# Check services
kubectl get svc -n perf-demo

# Check ingress
kubectl get ingress -n perf-demo

# View pod logs
kubectl logs -f deployment/perf-perf-tester -n perf-demo
----

=== Uninstalling

[source,bash]
----
# Full cleanup: deletes all ArgoCD apps and the argocd namespace
infrastructure\cleanupKubernetes.bat
----

=== Manual Teardown

[source,bash]
----
kubectl delete application perf-demo -n argocd
kubectl delete appproject perf-demo -n argocd
kubectl delete namespace perf-demo
----

== Helm Chart Structure

Each component follows a standard Helm chart structure:

[source,text]
----
component-name/
├── Chart.yaml              # Chart metadata
├── values.yaml             # Default values
└── templates/
    ├── _helpers.tpl        # Template helpers
    ├── deployment.yaml     # Kubernetes Deployment
    ├── service.yaml        # Kubernetes Service
    ├── configmap.yaml      # Configuration (optional)
    ├── secret.yaml         # Secrets (optional)
    └── pvc.yaml            # Persistent storage (optional)
----

=== Resource Requirements

All deployments include resource requests and limits:

[source,yaml]
----
resources:
  requests:
    memory: "256Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"
----

=== Available Helm Charts

[cols="2,3,2"]
|===
|Chart |Description |Default Replicas

|api-gateway
|Spring Cloud Gateway
|1

|config-server
|Spring Cloud Config Server
|1

|grafana
|Visualization
|1

|ibm-mq
|Message queue
|1

|ibm-mq-consumer
|MQ to Kafka bridge
|1

|ingress
|Ingress configuration
|N/A

|kafdrop
|Kafka UI
|1

|kafka
|Message broker
|1

|kafka-consumer
|Message processor
|1

|kafka-exporter
|Kafka metrics
|1

|loki
|Log aggregation
|1

|oracle
|Oracle XE database
|1

|oracle-exporter
|DB metrics
|1

|perf-tester
|Main application (includes perf-ui frontend)
|1

|prometheus
|Metrics collection
|1

|promtail
|Log shipping
|DaemonSet

|redis
|Cache / session store
|1

|redis-commander
|Redis web UI
|1

|sonarqube
|Code quality
|1

|tempo
|Tracing
|1

|trivy-operator
|Container image CVE scanning
|1
|===

== Production Considerations

=== High Availability

For production, increase replicas:

[source,yaml]
----
# values.yaml
replicaCount: 3

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2
----

=== Persistent Storage

Enable persistence for stateful components:

[source,yaml]
----
persistence:
  enabled: true
  size: 50Gi
  storageClass: "standard-rwo"
----

=== Security

. Change default passwords
. Enable TLS for all services
. Use network policies
. Enable pod security policies

=== Monitoring

. Configure alerting in Grafana
. Set up PagerDuty/Slack integrations
. Create runbooks for common alerts

== Rollback Procedures

=== Helm Rollback

[source,bash]
----
# List release history
helm history perf-perf-tester -n perf-demo

# Rollback to previous revision
helm rollback perf-perf-tester 1 -n perf-demo

# Rollback to specific revision
helm rollback perf-perf-tester 3 -n perf-demo
----

=== Docker Compose Rollback

[source,bash]
----
# Pull previous image version
docker compose -f infrastructure/docker/compose.yaml pull

# Restart with previous images
docker compose -f infrastructure/docker/compose.yaml up -d
----
